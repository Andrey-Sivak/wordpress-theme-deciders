on:
  push:
    branches:
      - main
      - prod
name: ðŸš€ Deploy - PROD
jobs:
  build-deploy:
    name: ðŸŽ‰ Build and deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4
      - name: ðŸšš Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: ðŸšš Install dependencies
        run: npm ci
      - name: ðŸš€ Build code
        run: |
          npm run build
      - name: ðŸšš Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: ðŸšš Install Composer
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php
          php -r "unlink('composer-setup.php');"
          mv composer.phar /usr/local/bin/composer

      - name: ðŸšš Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader
      - name: ðŸš€ Delete npm folder # a plug so that the ftp action does not load modules
        run: rm -r node_modules
      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.ftp_prod_server }}
          username: u2745588_webzayt
          password: ${{ secrets.ftp_prod_password }}
          server-dir: www/decidersy.ru/wp-content/themes/ds/
          exclude: |
            **/.git*
            **/.git*/**
            **/.vs*/**
            **/node_modules/**
            **/gulp/**
            **/assets/**
            **/guten/src/**
            !**/dist/**
            !**/guten/build/**
            **/.idea/*
            **/.husky/*
            **/assets/*
            **/gulp/*
            **/guten/node_modules/*
            **/guten/src/*
            **/tailwind-settings/*
            **/.commitlintrc.json
            **/.gitignore
            **/.prettierignore
            **/.prettierrc
            **/.prettierrc.json
            **/.stylelintrc.json
            **/.versionrc.json
            **/gulpfile.js
            **/LICENSE
            **/package.json
            **/package-lock.json
            **/phpcs.xml
            **/README.md
            **/readme.txt
            **/tailwind.config.cjs
